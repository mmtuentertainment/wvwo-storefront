# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# WV Wild Outdoors Storefront - CodeRabbit Configuration
# Aligned with Constitution v2.1.0 (7 Principles) - Rural West Virginia Family Business
# Simple static Astro site - NO Docker, NO databases, NO complex infrastructure
# Phase 3: Highway Hunter Capture (SEO + Content Hub + E-Commerce)

language: "en-US"
early_access: false

# Tone: Authentic, family-business focus - Direct and thorough with cultural sensitivity
tone_instructions: "Rural WV family business on US 19 near I-79 Exit 57. Focus: Owner-First Simplicity, Heart of WV (geographic positioning), Modular Services (free-tier), Developer-Managed, Dual-Experience (responsive web), Anti-MVP Bias, Appalachian Gateway Positioning. Surprise gift - no half-baked features. Kim's reputation depends on it."

reviews:
  profile: "assertive"  # Owner-First Simplicity + Anti-MVP Bias require thoroughness
  request_changes_workflow: true  # Block merges until issues resolved (Anti-MVP: no half-done features)
  high_level_summary: true
  high_level_summary_placeholder: "Generate a concise PR summary with: (1) What changed, (2) Why it matters for hunters/anglers, (3) Constitutional compliance status, (4) Files modified count"
  high_level_summary_instructions: |
    Generate a structured summary for WV Wild Outdoors PRs. This is a simple static Astro site for a hunting/fishing shop on US 19 near I-79 Exit 57 in Birch River, WV.

    ## PR Summary
    **What**: {one-line description of changes}
    **Why**: {business value for hunters/anglers or site visitors}
    **Files**: {count} modified | +{added}/-{removed} lines

    ## Constitution v2.1.0 Compliance (7 Principles)

    | Principle | Status | Notes |
    |-----------|--------|-------|
    | I. Owner-First Simplicity | ✅/⚠️/❌ | Kim can manage from phone? |
    | II. Heart of WV | ✅/⚠️/❌ | Authentic voice? US 19/I-79 positioning? |
    | III. Modular Services | ✅/⚠️/❌ | Free-tier? (Astro, Buttondown, Web3Forms) |
    | IV. Developer-Managed | ✅/⚠️/❌ | Matt owns infra, Kim owns content? |
    | V. Dual-Experience | ✅/⚠️/❌ | Mobile PageSpeed 90+? Responsive? |
    | VI. Anti-MVP Bias | ✅/⚠️/❌ | Complete feature? No TODOs? |
    | VII. Gateway Positioning | ✅/⚠️/❌ | I-79 Exit 57 / US 19 emphasized? |

    ## Tech Stack Check
    - [ ] Astro 5.x components (no React/Vue/Angular)
    - [ ] Tailwind CSS 4.x (design system classes)
    - [ ] Vanilla JS only (no frameworks)
    - [ ] Free-tier services (Cloudflare, Web3Forms, Buttondown)

    ## Voice & Content Check
    - [ ] Kim's voice (rural WV, not corporate)
    - [ ] No AI slop (Inter font, purple gradients, marketing speak)
    - [ ] Local terminology correct (buck season, WMA, etc.)
    - [ ] Geographic positioning present (US 19, I-79 Exit 57)

    ## Quality Gates
    **Internal Shipping** (Matt → Kim testing):
    - [ ] `npm run build` passes
    - [ ] Page renders correctly on mobile (375px)
    - [ ] Schema.org validates (if applicable)
    - [ ] Links work, no 404s

    **External Shipping** (Public launch):
    - [ ] Mobile PageSpeed 90+
    - [ ] All content verified with sources
    - [ ] SEO meta tags present
    - [ ] Accessibility basics (semantic HTML, alt text)

    ## Release Notes
    {concise bullet points for changelog, written in Kim's voice}

    ## Action Items
    - {specific next steps if any issues found}
  review_status: true
  commit_status: true
  fail_commit_status: true  # Hard fail on review errors
  collapse_walkthrough: false
  changed_files_summary: true
  sequence_diagrams: true
  estimate_code_review_effort: true
  assess_linked_issues: true
  related_issues: true
  related_prs: true
  suggested_labels: true
  auto_apply_labels: true
  suggested_reviewers: true
  poem: false  # No fluff - family business values efficiency

  # Path filters: Exclude generated/vendor files
  path_filters:
    - "!node_modules/**"
    - "!dist/**"
    - "!build/**"
    - "!*.lock"
    - "!package-lock.json"
    - "!pnpm-lock.yaml"
    - "!yarn.lock"
    - "!.pnpm-store/**"
    - "!.astro/**"
    - "!spec-kit/**"  # Submodule with own review process

  # Path-specific instructions aligned with Constitution v2.1.0
  path_instructions:
    # Astro Pages & Components - Core of the site
    - path: "wv-wild-web/src/**/*.astro"
      instructions: |
        CRITICAL - Constitution Compliance for Astro Components:

        Principle V (Dual-Experience Design):
        - Mobile-first responsive design (test at 375px, 768px, 1024px)
        - Public pages MUST score 90+ on mobile PageSpeed Insights
        - NO client-side JS frameworks (React, Vue, Angular, Svelte)
        - Vanilla JavaScript ONLY for interactivity

        Principle II (Heart of WV + VII Gateway Positioning):
        - Voice MUST be Kim's authentic rural WV (not corporate)
        - Geographic positioning: US 19, I-79 Exit 57, Birch River
        - Local terminology: buck season, WMA, DNR, etc.
        - NO AI slop: Inter font, purple gradients, marketing buzzwords

        Principle VI (Anti-MVP Bias):
        - NO "TODO: add later" comments
        - NO placeholder content ("lorem ipsum", "$99.99")
        - Error handling MUST be user-friendly
        - Accessibility from day one (semantic HTML, alt text, ARIA)

        Tech Stack:
        - Astro 5.x components with frontmatter
        - Tailwind CSS 4.x design system classes
        - Import from ../../components/, ../../layouts/, etc.

        File Size Guidelines:
        - Pages: ~300-500 lines typical
        - Components: <200 lines preferred
        - Extract repeated patterns to components

    # Store Data - Kim's inventory source of truth
    - path: "wv-wild-web/src/data/*.json"
      instructions: |
        CRITICAL - First-Party Source Data:
        - store.json contains Kim's official inventory sections
        - Category names MUST match Kim's exact terminology
        - Product data MUST be real (not placeholder)
        - Prices MUST be accurate for rural WV market

        Kim's Official 12 Sections (December 2025):
        Optics, Knives, Guns, Archery, Fishing, Rustic cabin goods,
        Boots, Ammo, Animal feed, Pet supplies, Family clothing, Seasonal garden supplies

        Principle II (Heart of WV):
        - Brand names spelled correctly (Remington, Hornady, Vortex)
        - Hunting/fishing terminology accurate
        - NO corporate product descriptions

    # Site Configuration
    - path: "wv-wild-web/src/config/*.ts"
      instructions: |
        Site Configuration - Source of Truth:
        - SITE_CONTACT: Phone, address, hours, maps URL
        - Highway positioning: I-79 Exit 57, US 19
        - Nearby WMAs with accurate drive times

        Principle VII (Gateway Positioning):
        - Geographic data MUST be accurate
        - Drive times MUST be verified
        - Exit numbers MUST be correct

    # Near Pages (Phase 3 Area Guides)
    - path: "wv-wild-web/src/pages/near/*.astro"
      instructions: |
        Phase 3 Area Guide Pages - Highway Hunter Capture:

        Research Requirements:
        - ALL facts MUST have official sources (USACE, WV DNR, Recreation.gov)
        - NO invented "local wisdom" - if not sourced, skip it
        - GPS coordinates MUST be verified for Schema.org

        Schema.org Requirements:
        - Place schema with geo coordinates
        - Address with verified postal code
        - Validate at schema.org/validator

        Content Structure (follow elk-river.astro pattern):
        - Hero with distance badge and acreage
        - Quick info bar (4-column grid)
        - Species/activities sections
        - Directions from shop
        - Facilities
        - What to bring (shop CTAs)
        - Newsletter capture

        Voice:
        - Kim's authentic style: "Stop by before you head out"
        - NOT: "Experience premier angling at this destination"

    # Shell Scripts - Principle IV (Developer-Managed Infrastructure)
    - path: "scripts/**/*.{sh,ps1}"
      instructions: |
        Cross-Platform Script Compatibility:
        - MUST provide both .sh (Bash) and .ps1 (PowerShell) versions
        - Bash scripts MUST include shebang: #!/bin/bash
        - Bash scripts MUST use strict mode: set -euo pipefail
        - PowerShell scripts MUST use: $ErrorActionPreference = "Stop"
        - NO platform-specific commands without fallbacks

        Principle IV (Developer-Managed Infrastructure):
        - These scripts are Matt's tools (Kim never runs them)
        - BUT must be well-documented for handoff/collaboration
        - Help text MUST be included (-h or --help flag)
        - Error messages MUST be descriptive

        Script Quality:
        - Function names MUST be descriptive (dev-start, dev-stop, dev-logs)
        - Colors/formatting MUST enhance readability
        - Exit codes MUST be meaningful (0 = success, non-zero = failure)
        - Idempotency: scripts should be safe to run multiple times

    # Documentation - Principle II (Heart of West Virginia)
    - path: "**/*.md"
      instructions: |
        CRITICAL - Constitution Principle II (Heart of West Virginia):
        - Voice MUST reflect rural WV authenticity
        - NO corporate buzzwords, jargon, or "startup-speak"
        - Cultural references MUST be accurate (buck season, meat hunters, freezers not trophies)
        - Faith references MUST be natural, not performative ("Lord willing" is authentic)

        Principle I (Owner-First Simplicity):
        - Kim-facing docs MUST avoid technical jargon
        - Matt-facing docs can be technical but clear
        - MUST explicitly state "Kim does this" vs "Matt does this" where applicable

        Documentation Quality:
        - Grammar/spelling MUST be correct (languagetool will check)
        - Code examples MUST be accurate and tested
        - Links MUST be valid (no broken references)
        - Markdown formatting MUST be consistent (markdownlint will check)

        Business Intelligence Preservation:
        - INTELLIGENCE.md MUST remain comprehensive (no deletions without justification)
        - Voice profiles MUST preserve actual Kim quotes
        - Conversation scripts MUST remain authentic and non-spoiling
        - Research findings MUST cite sources with credibility scores

        God File Prevention (DOCS):
        - Docs are EXPLICITLY EXCLUDED from strict line limits
        - Comprehensive documentation is valued over brevity
        - Acceptable sizes: 500-1000 lines for BLUEPRINT.md, INTELLIGENCE.md
        - Flag >2000 lines as WARNING (consider splitting into sections)

    # Spec Kit Contract Documentation - Service Interface Specs
    - path: "specs/**/contracts/*.md"
      instructions: |
        Service Interface Contract Documentation:
        - These files contain DOCUMENTATION EXAMPLES of API endpoints and configurations
        - API keys, tokens, and credentials shown are PLACEHOLDER EXAMPLES for documentation
        - Do NOT flag example API key patterns as real secrets (they are illustrative)
        - Example patterns like "key=abc123xyz" or "Content API key (query parameter)" are documentation
        - Focus review on accuracy of documented interfaces, not secret detection
        - Validate that example requests/responses match actual service behavior

    # Spec Kit directories - Spec-Driven Development
    - path: "specs/**/*.md"
      instructions: |
        Spec-Driven Development Framework:
        - Every spec directory (specs/NNN-feature/) MUST contain:
          - spec.md: User stories with acceptance criteria
          - plan.md: Implementation plan with constitutional checks
          - data-model.md: Service topology, data flows
          - tasks.md: Phased task breakdown
          - quickstart.md: Getting started guide (where applicable)
          - contracts/: Service interface definitions
          - checklists/: Requirements validation

        Constitutional Compliance:
        - spec.md MUST include Constitution Check section verifying all 6 principles (including Anti-MVP)
        - plan.md MUST explicitly address role boundaries (Kim vs Matt)
        - data-model.md MUST show service independence (Principle III)

        Principle VI (Anti-MVP Bias):
        - Acceptance criteria MUST define DONE (not "basic version works")
        - Tasks.md MUST include validation/testing tasks (not just implementation)
        - NO "Phase 1: MVP, Phase 2: Real Features" - build it right first time
        - Spec MUST address error handling, edge cases, and failure modes
        - "Out of scope" section MUST be justified (not arbitrary cost-cutting)

        Spec Kit Completeness Check:
        - If this PR is for a spec (specs/NNN-feature/), verify:
          - spec.md exists with user stories and acceptance criteria
          - plan.md exists with constitutional checks for all 6 principles
          - data-model.md exists with service topology and data flows
          - contracts/ directory exists with service interface definitions
          - tasks.md exists with phased breakdown and validation tasks
          - quickstart.md exists (if feature requires setup instructions)
          - checklists/ directory exists with requirements validation

        Roadmap Integration:
        - Check against FEATURE_ROADMAP.md (.specify/FEATURE_ROADMAP.md)
        - Verify spec is listed in roadmap with correct priority
        - Verify phase alignment (Infrastructure / Development / Testing / Pre-Launch / Production)
        - Update roadmap progress when marking spec complete

        Internal vs External Readiness:
        - Internal Shipping: Can ship with partial Spec Kit if feature works, Kim can use from phone, data persists, errors user-friendly, would-Kim-use-this passes
        - External Shipping: MUST have complete Spec Kit before public launch

        Documentation Quality:
        - User stories MUST use "As a [Kim/Matt/Customer]" format
        - Acceptance criteria MUST be testable
        - Tasks MUST be granular enough for single work sessions
        - Links to roadmap/constitution MUST be valid

    # Environment Files - Security
    - path: "**/{.env.example,.env.template}"
      instructions: |
        CRITICAL - Security & Developer-Managed Infrastructure:
        - .env.example files MUST use placeholders (CHANGE_ME, generate_random_string, etc.)
        - MUST include comments explaining each variable
        - MUST document how to generate secrets (e.g., "openssl rand -hex 32")
        - MUST NOT contain actual credentials

        Anti-MVP Bias EXCEPTION:
        - Placeholder data IS REQUIRED in .env.example files (security-by-design)
        - This is NOT a violation of "NO placeholder data" principle
        - Placeholders prevent accidental secret commits (intentional security practice)
        - Examples: "REPLACE_WITH_RANDOM_32_CHAR_STRING", "your-secret-here", "CHANGE_ME"
        - Industry standard practice for environment templates

        Validation:
        - All services requiring env vars MUST be documented
        - Variable names MUST be descriptive (DB_PASSWORD, not PASS)
        - Boolean values MUST use true/false (not 1/0, yes/no)

    # Configuration Files - Tech Stack Compliance
    - path: "**/{package.json,astro.config.mjs,tailwind.config.mjs}"
      instructions: |
        CRITICAL - Constitution Tech Stack Compliance:
        - Frontend MUST use Astro (NO Next.js, Nuxt, Gatsby substitutions)
        - Styling MUST use Tailwind CSS (NO Bootstrap, Material UI)
        - NO client-side frameworks for public pages (React, Vue, Angular)
        - Vanilla JavaScript ONLY for interactivity

        Dependencies:
        - MUST document why each dependency is needed
        - Minimize dependencies (prefer vanilla over libraries)
        - NO jQuery, Lodash, or utility belt libraries
        - Flag any React/Vue/Angular dependencies as CONSTITUTIONAL VIOLATION

    # PR Approval - Morale and Progress Tracking
    - path: "**/*"
      instructions: |
        When approving PRs (manual or upon request), provide an encouraging summary including:
        - What constitutional principles were followed well
        - Specific features/improvements that stood out
        - How this moves the project closer to launch readiness
        - A morale-boosting closing statement reflecting the rural WV family business voice

  # Labeling instructions - Constitution v2.1.0 (7 Principles)
  labeling_instructions:
    - label: "constitution-violation"
      instructions: "Apply if PR violates Constitution Principles I-VII (Owner-First, Heart of WV, Modular Services, Developer-Managed, Dual-Experience, Anti-MVP, Gateway Positioning)"
    - label: "owner-first-violation"
      instructions: "Apply if PR requires Kim to use terminal, edit config files, or exceed 15min training time (Principle I)"
    - label: "voice-authenticity"
      instructions: "Apply if PR contains corporate buzzwords, AI slop (Inter font, purple gradients), luxury language, or inauthentic WV voice (Principle II)"
    - label: "gateway-positioning"
      instructions: "Apply if PR adds/improves geographic SEO: US 19, I-79 Exit 57, drive times to WMAs/lakes (Principle VII)"
    - label: "role-boundary-violation"
      instructions: "Apply if PR blurs Kim vs Matt responsibilities (Principle IV)"
    - label: "mobile-performance"
      instructions: "Apply if PR degrades mobile PageSpeed score below 90 or breaks responsive design (Principle V)"
    - label: "anti-mvp-violation"
      instructions: "Apply if PR ships incomplete features, has 'TODO: add later' comments, missing error handling, placeholder data, or defers critical functionality (Principle VI)"
    - label: "internal-ready"
      instructions: "Apply if PR passes Internal Shipping: npm run build passes, page renders on mobile, schema validates, links work"
    - label: "phase-3-content"
      instructions: "Apply if PR adds area pages (/near/*), SEO content, or geographic guides for Highway Hunter Capture phase"
    - label: "near-page"
      instructions: "Apply if PR adds/modifies /near/* area guide pages (WMAs, lakes, recreation areas)"
    - label: "store-data"
      instructions: "Apply if PR modifies store.json (Kim's inventory sections, products, categories)"
    - label: "astro-frontend"
      instructions: "Apply if PR contains Astro components, pages, or Tailwind styles"
    - label: "documentation"
      instructions: "Apply if PR modifies markdown files, specs, or SPARC documentation"
    - label: "tech-stack-compliance"
      instructions: "Apply if PR validates or violates approved tech stack (Astro 5.x, Tailwind 4.x, vanilla JS only)"
    - label: "spec-complete"
      instructions: "Apply if PR includes SPARC spec (spec.md with research sources, implementation plan, voice guidelines)"

  auto_review:
    enabled: true
    auto_incremental_review: true
    drafts: false  # No draft reviews - ship complete work (Anti-MVP Bias)
    ignore_title_keywords: []
    labels: []
    base_branches: ["main", "develop"]

  # Finishing touches
  finishing_touches:
    docstrings:
      enabled: true
    unit_tests:
      enabled: false  # No formal test framework yet (infrastructure-first project)

  # Pre-merge checks
  pre_merge_checks:
    docstrings:
      mode: "warning"  # Warn but don't block (no code yet)
    unit_tests:
      mode: "off"  # Disabled until test framework implemented

  # Tools Configuration - Simple static site stack
  tools:
    # JavaScript/TypeScript linters
    eslint:
      enabled: true  # Astro/JS linting
    biome:
      enabled: false  # Not using Biome

    # Security scanners
    gitleaks:
      enabled: true  # Secret detection
    semgrep:
      enabled: false  # Requires custom rules
    checkov:
      enabled: false  # No Docker/infrastructure

    # Infrastructure linters (disabled - no Docker)
    hadolint:
      enabled: false  # No Dockerfiles
    actionlint:
      enabled: false  # No GitHub Actions yet
    shellcheck:
      enabled: false  # No shell scripts in main workflow
    yamllint:
      enabled: true  # YAML validation for configs

    # Documentation linters
    markdownlint:
      enabled: true  # Markdown formatting
    languagetool:
      enabled: true  # Grammar/style (critical for Kim's voice)
      level: "default"

# Knowledge Base - Learn from codebase
knowledge_base:
  opt_out: false
  web_search:
    enabled: true  # Search for Astro, Tailwind, WV DNR docs
  code_guidelines:
    enabled: true
    file_patterns:
      - "CLAUDE.md"
      - ".specify/memory/constitution.md"
      - "docs/BLUEPRINT.md"
      - "docs/WVWO_FRONTEND_AESTHETICS.md"
      - "docs/specs/**/*.md"
  learnings:
    scope: "local"

chat:
  auto_reply: true
