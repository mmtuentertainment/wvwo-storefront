---
// SignatureCapture.astro
// Canvas and typed signature component for legal agreements
// Uses signature_pad library (4.52KB, vanilla JS, touch support)

interface Props {
  componentId?: string;
  required?: boolean;
}

const {
  componentId = 'signature-capture',
  required = true
} = Astro.props;
---

<div id={componentId} class="space-y-4" data-signature-capture>
  <div class="text-center mb-6">
    <h3 class="font-display font-bold text-lg text-brand-brown mb-2">
      Your Signature
    </h3>
    <p class="text-sm text-stone-600">
      Sign below to confirm your agreement. You can draw your signature or type your full legal name.
    </p>
  </div>

  <!-- Canvas Signature -->
  <div class="space-y-2">
    <label class="block text-sm font-medium text-stone-700">
      Draw Your Signature
    </label>
    <div class="relative">
      <canvas
        id={`${componentId}-canvas`}
        class="w-full h-32 border-2 border-stone-300 rounded-sm bg-white cursor-crosshair touch-none"
        data-signature-canvas
        aria-label="Signature canvas - draw your signature here"
        role="img"
      ></canvas>
      <button
        type="button"
        class="absolute top-2 right-2 text-stone-400 hover:text-stone-600 transition-colors p-1 rounded focus:outline-none focus:ring-2 focus:ring-brand-orange"
        data-clear-canvas
        aria-label="Clear signature"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
      </button>
    </div>
    <p class="text-xs text-stone-500">Use your finger, stylus, or mouse to sign</p>
  </div>

  <!-- OR Divider -->
  <div class="flex items-center gap-4">
    <div class="flex-1 h-px bg-stone-300"></div>
    <span class="text-sm text-stone-500 font-medium">OR</span>
    <div class="flex-1 h-px bg-stone-300"></div>
  </div>

  <!-- Typed Signature -->
  <div class="space-y-2">
    <label for={`${componentId}-typed`} class="block text-sm font-medium text-stone-700">
      Type Your Full Legal Name
    </label>
    <input
      type="text"
      id={`${componentId}-typed`}
      name="typed_signature"
      placeholder="John A. Smith"
      autocomplete="name"
      aria-describedby={`${componentId}-validation`}
      class="w-full px-4 py-3 border-2 border-stone-300 rounded-sm font-hand text-2xl text-stone-800 placeholder:text-stone-400 placeholder:font-sans placeholder:text-base focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green"
      data-typed-signature
    />
    <p class="text-xs text-stone-500">Type your name exactly as it appears on your ID</p>
  </div>

  <!-- Hidden inputs for form submission -->
  <input type="hidden" name="signature_type" value="" data-signature-type />
  <input type="hidden" name="signature_value" value="" data-signature-value />
  <input type="hidden" name="signature_timestamp" value="" data-signature-timestamp />

  <!-- Attestation checkbox -->
  <label class="flex items-start gap-3 cursor-pointer select-none mt-6 p-4 bg-stone-50 rounded-sm border border-stone-200">
    <input
      type="checkbox"
      id={`${componentId}-consent`}
      class="mt-1 w-5 h-5 rounded border-stone-300 text-sign-green focus:ring-sign-green"
      data-consent-checkbox
      aria-required={required ? 'true' : 'false'}
      required={required}
    />
    <span class="text-sm text-stone-700">
      I consent to sign this document electronically. I understand that my electronic signature
      has the same legal effect as a handwritten signature.
    </span>
  </label>

  <!-- Validation message -->
  <p
    id={`${componentId}-validation`}
    class="text-sm text-red-600 hidden"
    role="alert"
    aria-live="polite"
    data-validation-message
  >
    Please provide a signature (draw or type) and check the consent box.
  </p>
</div>

<!-- signature_pad library from CDN -->
<script is:inline src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.0/dist/signature_pad.umd.min.js"></script>

<script>
  function initSignatureCapture() {
    const captures = document.querySelectorAll('[data-signature-capture]');

    captures.forEach((capture) => {
      const captureEl = capture as HTMLElement;

      // Idempotency guard
      if (captureEl.dataset.sigInit === 'true') return;
      captureEl.dataset.sigInit = 'true';

      const canvas = captureEl.querySelector('[data-signature-canvas]') as HTMLCanvasElement;
      const clearBtn = captureEl.querySelector('[data-clear-canvas]') as HTMLButtonElement;
      const typedInput = captureEl.querySelector('[data-typed-signature]') as HTMLInputElement;
      const signatureType = captureEl.querySelector('[data-signature-type]') as HTMLInputElement;
      const signatureValue = captureEl.querySelector('[data-signature-value]') as HTMLInputElement;
      const signatureTimestamp = captureEl.querySelector('[data-signature-timestamp]') as HTMLInputElement;
      const consentCheckbox = captureEl.querySelector('[data-consent-checkbox]') as HTMLInputElement;
      const validationMessage = captureEl.querySelector('[data-validation-message]') as HTMLElement;

      // Initialize signature_pad
      // @ts-ignore - signature_pad loaded from CDN
      const signaturePad = new window.SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(30, 30, 30)',
        minWidth: 1,
        maxWidth: 3
      });

      // Resize canvas to match container
      const resizeCanvas = () => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        canvas.getContext('2d')?.scale(ratio, ratio);
        signaturePad.clear(); // Clear after resize to avoid distortion
      };

      // Initial resize
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      // Clear canvas button
      clearBtn?.addEventListener('click', () => {
        signaturePad.clear();
        updateSignatureData();
      });

      // When canvas is signed, clear typed input
      signaturePad.addEventListener?.('endStroke', () => {
        if (!signaturePad.isEmpty()) {
          typedInput.value = '';
          updateSignatureData();
        }
      });

      // Fallback for older signature_pad versions
      canvas.addEventListener('mouseup', () => {
        if (!signaturePad.isEmpty()) {
          typedInput.value = '';
          updateSignatureData();
        }
      });
      canvas.addEventListener('touchend', () => {
        if (!signaturePad.isEmpty()) {
          typedInput.value = '';
          updateSignatureData();
        }
      });

      // When typing, clear canvas
      typedInput?.addEventListener('input', () => {
        if (typedInput.value.trim()) {
          signaturePad.clear();
        }
        updateSignatureData();
      });

      // Update hidden fields with signature data
      const updateSignatureData = () => {
        const hasCanvasSignature = !signaturePad.isEmpty();
        const hasTypedSignature = typedInput.value.trim().length >= 2;

        if (hasCanvasSignature) {
          signatureType.value = 'canvas';
          signatureValue.value = signaturePad.toDataURL('image/png');
          signatureTimestamp.value = new Date().toISOString();
        } else if (hasTypedSignature) {
          signatureType.value = 'typed';
          signatureValue.value = typedInput.value.trim();
          signatureTimestamp.value = new Date().toISOString();
        } else {
          signatureType.value = '';
          signatureValue.value = '';
          signatureTimestamp.value = '';
        }
      };

      // Validation function (exposed for parent form)
      (captureEl as any).validateSignature = (): boolean => {
        const hasSignature = signatureType.value !== '' && signatureValue.value !== '';
        const hasConsent = consentCheckbox.checked;

        if (!hasSignature || !hasConsent) {
          validationMessage.classList.remove('hidden');
          return false;
        }

        validationMessage.classList.add('hidden');
        return true;
      };

      // Get signature data (exposed for parent form)
      (captureEl as any).getSignatureData = () => {
        return {
          type: signatureType.value,
          value: signatureValue.value,
          timestamp: signatureTimestamp.value,
          consent: consentCheckbox.checked
        };
      };

      // Cleanup on ViewTransitions
      document.addEventListener('astro:before-swap', () => {
        window.removeEventListener('resize', resizeCanvas);
        captureEl.dataset.sigInit = 'false';
      }, { once: true });
    });
  }

  // Initialize
  initSignatureCapture();
  document.addEventListener('astro:page-load', initSignatureCapture);
</script>

<style>
  /* Handwriting-style font for typed signatures */
  .font-hand {
    font-family: 'Brush Script MT', 'Segoe Script', cursive;
    font-style: italic;
  }
</style>
