---
/**
 * EmergencyContactsSection.astro
 * SPEC-17: P0 Safety-Critical Emergency Contact Display
 *
 * Displays multi-tier emergency contacts for backcountry areas with:
 * - Priority-sorted contacts (911 first, poison control last)
 * - Tier-colored badges for quick visual identification
 * - Accessible tel: links for one-tap calling
 * - Satellite SOS device recommendations
 * - Self-rescue awareness section
 * - Nearest hospital/trauma center info
 *
 * SAFETY CRITICAL: This component displays life-safety information.
 * All phone numbers must be clickable and properly formatted.
 *
 * @module components/backcountry/EmergencyContactsSection
 */

import {
  type TieredEmergencyContact,
  type EmergencyTier,
  EMERGENCY_TIER_COLORS,
  EMERGENCY_TIER_LABELS,
  getEmergencyTierColor,
  sortEmergencyContactsByTier,
  has24x7EmergencyContact,
} from '../../types/backcountry-template-types';

interface HospitalInfo {
  /** Hospital name */
  name: string;
  /** Distance from area (e.g., "45 minutes") */
  distance: string;
  /** Trauma level (e.g., "Level II Trauma Center") */
  traumaLevel?: string;
  /** Phone number */
  phone?: string;
  /** Address */
  address?: string;
}

interface SatelliteRecommendation {
  /** Importance level for satellite device */
  importance: 'essential' | 'recommended' | 'optional';
  /** Recommended devices */
  devices: string[];
  /** Coverage notes */
  coverageNotes?: string;
}

interface Props {
  /** Array of tiered emergency contacts (will be sorted by priority) */
  contacts: TieredEmergencyContact[];
  /** Area name for display */
  areaName: string;
  /** Satellite communication recommendation */
  satelliteRecommendation?: SatelliteRecommendation;
  /** Nearest hospital information */
  nearestHospital?: HospitalInfo;
  /** Self-rescue warning text (Kim's voice) */
  selfRescueWarning?: string;
  /** Show 24/7 availability badge */
  show24x7Badge?: boolean;
  /** Background variant */
  variant?: 'white' | 'cream';
}

const {
  contacts,
  areaName,
  satelliteRecommendation,
  nearestHospital,
  selfRescueWarning,
  show24x7Badge = true,
  variant = 'white',
} = Astro.props;

// Sort contacts by tier priority
const sortedContacts = sortEmergencyContactsByTier(contacts);
const has24x7 = has24x7EmergencyContact(contacts);

const bgClass = variant === 'white' ? 'bg-white' : 'bg-brand-cream';

/**
 * Format phone number for tel: href (strip non-numeric except +)
 */
function formatPhoneHref(phone: string): string {
  return phone.replace(/[^0-9+]/g, '');
}

/**
 * Get importance badge styling for satellite recommendation
 */
function getSatelliteImportanceStyle(importance: 'essential' | 'recommended' | 'optional'): string {
  switch (importance) {
    case 'essential':
      return 'bg-red-700 text-white';
    case 'recommended':
      return 'bg-brand-orange text-white';
    case 'optional':
      return 'bg-sign-green text-white';
    default:
      return 'bg-brand-brown text-white';
  }
}

/**
 * Get importance label
 */
function getSatelliteImportanceLabel(importance: 'essential' | 'recommended' | 'optional'): string {
  switch (importance) {
    case 'essential':
      return 'ESSENTIAL';
    case 'recommended':
      return 'Strongly Recommended';
    case 'optional':
      return 'Optional';
    default:
      return 'Recommended';
  }
}
---

<section
  class:list={['py-12 md:py-16', bgClass]}
  aria-labelledby="emergency-contacts-heading"
>
  <div class="container mx-auto px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Section Header with Warning Icon -->
      <div class="flex items-center gap-3 mb-6">
        <svg
          class="w-8 h-8 text-red-700 flex-shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          />
        </svg>
        <div>
          <h2
            id="emergency-contacts-heading"
            class="font-display font-bold text-2xl md:text-3xl text-brand-brown"
          >
            Emergency Contacts
          </h2>
          {show24x7Badge && has24x7 && (
            <span class="inline-block mt-1 bg-sign-green text-white text-xs font-body font-bold px-2 py-0.5 rounded-sm">
              24/7 Coverage Available
            </span>
          )}
        </div>
      </div>

      <!-- Emergency Contacts Grid -->
      <div class="grid gap-4 md:grid-cols-2 mb-8">
        {sortedContacts.map((contact: TieredEmergencyContact) => (
          <div
            class="bg-brand-cream p-5 rounded-sm border-l-4"
            style={`border-left-color: var(--tier-color-${contact.tier})`}
          >
            <!-- Tier Badge -->
            <div class="flex items-start justify-between mb-3">
              <span
                class:list={[
                  'inline-block px-3 py-1 rounded-sm font-body text-xs font-bold',
                  getEmergencyTierColor(contact.tier),
                ]}
              >
                {EMERGENCY_TIER_LABELS[contact.tier]}
              </span>
              {contact.available && (
                <span class="font-body text-xs text-brand-mud">
                  {contact.available}
                </span>
              )}
            </div>

            <!-- Service Name -->
            <h3 class="font-display text-lg font-bold text-brand-brown mb-2">
              {contact.service}
            </h3>

            <!-- Phone Number (Large, Clickable) -->
            <a
              href={`tel:${formatPhoneHref(contact.phone)}`}
              class="inline-flex items-center gap-2 font-display text-xl font-bold text-brand-brown hover:text-brand-orange focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 motion-safe:transition-colors motion-reduce:transition-none"
              aria-label={`Call ${contact.service} at ${contact.phone}`}
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                />
              </svg>
              {contact.phone}
            </a>

            <!-- Response Time -->
            {contact.responseTime && (
              <p class="font-body text-sm text-brand-mud mt-2">
                <span class="font-medium">Response:</span> {contact.responseTime}
              </p>
            )}

            <!-- Capabilities -->
            {contact.capabilities && contact.capabilities.length > 0 && (
              <div class="mt-3 flex flex-wrap gap-1">
                {contact.capabilities.map((capability: string) => (
                  <span class="bg-white px-2 py-0.5 rounded-sm font-body text-xs text-brand-mud">
                    {capability}
                  </span>
                ))}
              </div>
            )}

            <!-- Notes -->
            {contact.notes && (
              <p class="font-body text-sm text-brand-mud mt-2 italic">
                {contact.notes}
              </p>
            )}
          </div>
        ))}
      </div>

      <!-- Satellite Communication Recommendation -->
      {satelliteRecommendation && (
        <div class="bg-brand-cream p-6 rounded-sm border-l-4 border-brand-orange mb-8">
          <div class="flex items-start gap-4">
            <!-- Satellite Icon -->
            <svg
              class="w-8 h-8 text-brand-orange flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"
              />
            </svg>

            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="font-display text-lg font-bold text-brand-brown">
                  Satellite Communication
                </h3>
                <span
                  class:list={[
                    'px-2 py-0.5 rounded-sm font-body text-xs font-bold',
                    getSatelliteImportanceStyle(satelliteRecommendation.importance),
                  ]}
                >
                  {getSatelliteImportanceLabel(satelliteRecommendation.importance)}
                </span>
              </div>

              <p class="font-body text-sm text-brand-mud mb-3">
                Cell coverage is unreliable in {areaName}. A satellite communication device
                provides emergency SOS capability when you have no signal.
              </p>

              {satelliteRecommendation.devices.length > 0 && (
                <div class="mb-3">
                  <p class="font-body text-sm font-medium text-brand-brown mb-1">
                    Compatible Devices:
                  </p>
                  <div class="flex flex-wrap gap-2">
                    {satelliteRecommendation.devices.map((device: string) => (
                      <span class="bg-white px-2 py-1 rounded-sm font-body text-sm text-brand-mud">
                        {device}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {satelliteRecommendation.coverageNotes && (
                <p class="font-body text-xs text-brand-mud italic">
                  {satelliteRecommendation.coverageNotes}
                </p>
              )}
            </div>
          </div>
        </div>
      )}

      <!-- Nearest Hospital -->
      {nearestHospital && (
        <div class="bg-brand-cream p-6 rounded-sm border-l-4 border-blue-700 mb-8">
          <div class="flex items-start gap-4">
            <!-- Hospital Icon -->
            <svg
              class="w-8 h-8 text-blue-700 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
              />
            </svg>

            <div class="flex-1">
              <h3 class="font-display text-lg font-bold text-brand-brown mb-1">
                Nearest Medical Facility
              </h3>

              <p class="font-display text-xl font-bold text-brand-brown">
                {nearestHospital.name}
              </p>

              <div class="grid grid-cols-2 gap-4 mt-3">
                <div>
                  <p class="font-body text-sm text-brand-mud">
                    <span class="font-medium">Distance:</span> {nearestHospital.distance}
                  </p>
                  {nearestHospital.traumaLevel && (
                    <p class="font-body text-sm text-brand-mud">
                      <span class="font-medium">Level:</span> {nearestHospital.traumaLevel}
                    </p>
                  )}
                </div>

                {nearestHospital.phone && (
                  <div>
                    <a
                      href={`tel:${formatPhoneHref(nearestHospital.phone)}`}
                      class="inline-flex items-center gap-2 font-body text-sm font-medium text-blue-700 hover:underline"
                      aria-label={`Call ${nearestHospital.name} at ${nearestHospital.phone}`}
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                      </svg>
                      {nearestHospital.phone}
                    </a>
                  </div>
                )}
              </div>

              {nearestHospital.address && (
                <p class="font-body text-sm text-brand-mud mt-2">
                  {nearestHospital.address}
                </p>
              )}
            </div>
          </div>
        </div>
      )}

      <!-- Self-Rescue Warning (Kim's Voice) -->
      {selfRescueWarning && (
        <aside
          class="bg-red-50 border-l-4 border-red-700 p-5 rounded-sm"
          role="alert"
          aria-label="Self-rescue awareness warning"
        >
          <div class="flex items-start gap-4">
            <svg
              class="w-6 h-6 text-red-700 flex-shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>

            <div>
              <h3 class="font-display text-lg font-bold text-red-800 mb-2">
                Be Prepared for Self-Rescue
              </h3>
              <p class="font-hand text-base text-red-800 leading-relaxed">
                {selfRescueWarning}
              </p>
            </div>
          </div>
        </aside>
      )}

      <!-- Default Self-Rescue Warning if none provided -->
      {!selfRescueWarning && (
        <aside
          class="bg-red-50 border-l-4 border-red-700 p-5 rounded-sm"
          role="alert"
          aria-label="Self-rescue awareness warning"
        >
          <div class="flex items-start gap-4">
            <svg
              class="w-6 h-6 text-red-700 flex-shrink-0 mt-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>

            <div>
              <h3 class="font-display text-lg font-bold text-red-800 mb-2">
                Be Prepared for Self-Rescue
              </h3>
              <p class="font-hand text-base text-red-800 leading-relaxed">
                "In remote backcountry, help can be hours away. Carry a first aid kit,
                know basic wilderness medicine, and always let someone know your plans.
                Be ready to get yourself out." - Kim
              </p>
            </div>
          </div>
        </aside>
      )}
    </div>
  </div>
</section>

<style>
  /* Tier color CSS custom properties for border colors */
  [style*="--tier-color-primary"] {
    border-left-color: #b91c1c;
  }
  [style*="--tier-color-sar"] {
    border-left-color: #ea580c;
  }
  [style*="--tier-color-agency"] {
    border-left-color: #2E7D32;
  }
  [style*="--tier-color-medical"] {
    border-left-color: #1d4ed8;
  }
  [style*="--tier-color-poison"] {
    border-left-color: #7e22ce;
  }
</style>
