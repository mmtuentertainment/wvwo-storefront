---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ScrollwrapModal from '../components/ui/ScrollwrapModal.astro';
import SignatureCapture from '../components/ui/SignatureCapture.astro';
import { SITE_CONTACT } from '../config/siteContact';

// Web3Forms access key
const WEB3FORMS_KEY = '30e563a3-580e-402c-bbf3-32565bc8c391';
const TERMS_VERSION = '2025-12-v1';
---

<Layout
  title="FFL Transfer Request | WV Wild Outdoors"
  description="Submit your FFL transfer request online. Read and agree to our terms, provide your information, and we'll process your firearm transfer."
>
  <Header />

  <main class="bg-brand-cream min-h-screen py-12 md:py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-2xl mx-auto">

        <!-- Page Header -->
        <div class="text-center mb-8">
          <span class="inline-block bg-sign-green/10 text-sign-green px-3 py-1 rounded text-sm font-medium mb-4">
            Step 1 of 2
          </span>
          <h1 class="font-display font-bold text-3xl md:text-4xl text-brand-brown mb-4">
            FFL Transfer Request
          </h1>
          <p class="text-stone-600">
            Please provide your information below. Before submitting, you'll need to
            read and agree to our terms and sign electronically.
          </p>
        </div>

        <!-- Form -->
        <form
          id="ffl-transfer-form"
          action="https://api.web3forms.com/submit"
          method="POST"
          class="bg-white rounded-lg shadow-sm border border-stone-100 p-6 md:p-8"
          data-ffl-form
        >
          <!-- Web3Forms hidden fields -->
          <input type="hidden" name="access_key" value={WEB3FORMS_KEY} />
          <input type="hidden" name="subject" value="FFL Transfer Request" />
          <input type="hidden" name="from_name" value="WV Wild Outdoors Website" />
          <input type="hidden" name="redirect" value="/ffl-transfer-success" />

          <!-- Hidden fields for compliance data -->
          <input type="hidden" name="terms_version" value={TERMS_VERSION} />
          <input type="hidden" name="consent_data" value="" />
          <input type="hidden" name="submission_timestamp" value="" />
          <input type="hidden" name="device_info" value="" />

          <!-- Honeypot -->
          <input type="checkbox" name="botcheck" class="hidden" style="display:none" />

          <!-- Customer Information -->
          <fieldset class="space-y-4 mb-8">
            <legend class="font-display font-bold text-lg text-brand-brown mb-4">
              Your Information
            </legend>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="name" class="block text-sm font-medium text-stone-700 mb-1">
                  Full Name *
                </label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  autocomplete="name"
                  class="w-full px-4 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green"
                />
              </div>

              <div>
                <label for="phone" class="block text-sm font-medium text-stone-700 mb-1">
                  Phone Number *
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  autocomplete="tel"
                  class="w-full px-4 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green"
                />
              </div>
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-stone-700 mb-1">
                Email (optional, for confirmation)
              </label>
              <input
                type="email"
                id="email"
                name="email"
                autocomplete="email"
                class="w-full px-4 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green"
              />
            </div>
          </fieldset>

          <!-- Firearm Information -->
          <fieldset class="space-y-4 mb-8">
            <legend class="font-display font-bold text-lg text-brand-brown mb-4">
              Firearm Details
            </legend>

            <div>
              <label for="firearm_description" class="block text-sm font-medium text-stone-700 mb-1">
                Firearm Make/Model *
              </label>
              <input
                type="text"
                id="firearm_description"
                name="firearm_description"
                required
                placeholder="e.g., Glock 19 Gen 5, Ruger 10/22"
                class="w-full px-4 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green"
              />
            </div>

            <div>
              <label for="seller" class="block text-sm font-medium text-stone-700 mb-1">
                Where are you purchasing from? *
              </label>
              <input
                type="text"
                id="seller"
                name="seller"
                required
                placeholder="e.g., Palmetto State Armory, GunBroker, private seller"
                class="w-full px-4 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green"
              />
            </div>

            <div>
              <label for="notes" class="block text-sm font-medium text-stone-700 mb-1">
                Additional Notes
              </label>
              <textarea
                id="notes"
                name="notes"
                rows="3"
                placeholder="Any timing preferences or questions..."
                class="w-full px-4 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green resize-none"
              ></textarea>
            </div>
          </fieldset>

          <!-- Legal Agreement Section -->
          <fieldset class="mb-8 p-4 bg-stone-50 rounded-lg border border-stone-200">
            <legend class="font-display font-bold text-lg text-brand-brown mb-4 px-2">
              Legal Agreement
            </legend>

            <p class="text-sm text-stone-600 mb-4">
              Before we can process your FFL transfer request, you must read and agree
              to our Terms of Service and Privacy Policy.
            </p>

            <!-- Agreement status indicator -->
            <div
              id="agreement-status"
              class="flex items-center gap-3 p-3 rounded border"
              data-agreement-status="pending"
            >
              <div class="w-8 h-8 rounded-full flex items-center justify-center bg-stone-200" data-status-icon>
                <svg class="w-5 h-5 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0H9m3-6V7a3 3 0 00-6 0v4a3 3 0 006 0z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <p class="font-medium text-stone-700" data-status-text>Agreement Required</p>
                <p class="text-sm text-stone-500" data-status-desc>Click below to read and agree to our terms.</p>
              </div>
            </div>

            <button
              type="button"
              id="open-terms-btn"
              class="mt-4 w-full bg-brand-brown text-white font-bold py-3 rounded hover:bg-brand-brown/90 transition-colors"
              data-scrollwrap-trigger
              onclick="openScrollwrapModal('scrollwrap-modal')"
            >
              Read & Agree to Terms
            </button>
          </fieldset>

          <!-- Signature Section (hidden until agreed) -->
          <fieldset id="signature-section" class="mb-8 hidden" data-signature-section>
            <legend class="font-display font-bold text-lg text-brand-brown mb-4">
              Electronic Signature
            </legend>
            <SignatureCapture componentId="ffl-signature" required={true} />
          </fieldset>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-sign-green text-white font-bold py-4 rounded hover:bg-green-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-sign-green"
            disabled
          >
            Submit Transfer Request
          </button>

          <p class="text-xs text-stone-500 text-center mt-4">
            We'll call you within 1 business day with our FFL information.
            Questions? Call us at <a href={SITE_CONTACT.phoneHref} class="text-brand-orange hover:underline">{SITE_CONTACT.phoneDisplay}</a>
          </p>
        </form>

        <!-- Back link -->
        <div class="text-center mt-6">
          <a
            href="/ffl-transfers"
            class="text-brand-orange hover:underline text-sm"
          >
            ← Back to FFL Transfers
          </a>
        </div>

      </div>
    </div>
  </main>

  <Footer />

  <!-- Scrollwrap Modal -->
  <ScrollwrapModal modalId="scrollwrap-modal" termsVersion={TERMS_VERSION} />
</Layout>

<script>
  function initFFLForm() {
    const form = document.getElementById('ffl-transfer-form') as HTMLFormElement;
    const signatureSection = document.getElementById('signature-section') as HTMLElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const agreementStatus = document.getElementById('agreement-status') as HTMLElement;
    const statusIcon = agreementStatus?.querySelector('[data-status-icon]') as HTMLElement;
    const statusText = agreementStatus?.querySelector('[data-status-text]') as HTMLElement;
    const statusDesc = agreementStatus?.querySelector('[data-status-desc]') as HTMLElement;
    const openTermsBtn = document.getElementById('open-terms-btn') as HTMLButtonElement;

    if (!form) return;

    // Idempotency guard
    if (form.dataset.formInit === 'true') return;
    form.dataset.formInit = 'true';

    let hasAgreed = false;

    // Listen for agreement from modal
    document.addEventListener('scrollwrap:agreed', ((e: CustomEvent) => {
      hasAgreed = true;

      // Update consent_data hidden field
      const consentInput = form.querySelector('[name="consent_data"]') as HTMLInputElement;
      if (consentInput) {
        consentInput.value = JSON.stringify(e.detail);
      }

      // Update UI
      agreementStatus.dataset.agreementStatus = 'agreed';
      agreementStatus.classList.remove('bg-stone-50', 'border-stone-200');
      agreementStatus.classList.add('bg-sign-green/10', 'border-sign-green');

      statusIcon.classList.remove('bg-stone-200');
      statusIcon.classList.add('bg-sign-green');
      statusIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

      statusText.textContent = 'Agreement Confirmed';
      statusText.classList.remove('text-stone-700');
      statusText.classList.add('text-sign-green');
      statusDesc.textContent = 'You agreed to Terms of Service and Privacy Policy.';

      openTermsBtn.textContent = '✓ Terms Accepted';
      openTermsBtn.disabled = true;
      openTermsBtn.classList.remove('bg-brand-brown', 'hover:bg-brand-brown/90');
      openTermsBtn.classList.add('bg-sign-green/20', 'text-sign-green', 'cursor-default');

      // Show signature section
      signatureSection.classList.remove('hidden');

      // Scroll to signature section
      signatureSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    }) as EventListener);

    // Form submission
    form.addEventListener('submit', (e) => {
      // Validate agreement
      if (!hasAgreed) {
        e.preventDefault();
        alert('Please read and agree to our Terms of Service and Privacy Policy.');
        return;
      }

      // Validate signature
      const signatureCapture = document.querySelector('[data-signature-capture]') as any;
      if (signatureCapture?.validateSignature && !signatureCapture.validateSignature()) {
        e.preventDefault();
        signatureSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return;
      }

      // Add submission timestamp
      const timestampInput = form.querySelector('[name="submission_timestamp"]') as HTMLInputElement;
      if (timestampInput) {
        timestampInput.value = new Date().toISOString();
      }

      // Add device info
      const deviceInput = form.querySelector('[name="device_info"]') as HTMLInputElement;
      if (deviceInput) {
        deviceInput.value = JSON.stringify({
          user_agent: navigator.userAgent,
          screen_size: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language
        });
      }

      // Update subject with customer name
      const nameInput = form.querySelector('[name="name"]') as HTMLInputElement;
      const subjectInput = form.querySelector('[name="subject"]') as HTMLInputElement;
      if (nameInput && subjectInput && nameInput.value) {
        subjectInput.value = `FFL Transfer Request - ${nameInput.value}`;
      }
    });

    // Enable submit button when signature is provided
    const checkSubmitReady = () => {
      const signatureCapture = document.querySelector('[data-signature-capture]') as any;
      const sigData = signatureCapture?.getSignatureData?.();
      const hasSignature = sigData?.type && sigData?.value && sigData?.consent;

      submitBtn.disabled = !hasAgreed || !hasSignature;
    };

    // Watch for signature changes
    const signatureCapture = document.querySelector('[data-signature-capture]');
    if (signatureCapture) {
      signatureCapture.addEventListener('input', checkSubmitReady);
      signatureCapture.addEventListener('change', checkSubmitReady);
      signatureCapture.addEventListener('click', () => setTimeout(checkSubmitReady, 100));
    }

    // Cleanup
    document.addEventListener('astro:before-swap', () => {
      form.dataset.formInit = 'false';
    }, { once: true });
  }

  initFFLForm();
  document.addEventListener('astro:page-load', initFFLForm);
</script>
