---
/**
 * Historic Site Page - Dynamic Route
 * SPEC-19: Dynamic route for historic site content
 *
 * Renders HistoricTemplate with data merged from:
 * 1. Content collection frontmatter (title, description, coordinates, etc.)
 * 2. Data file at /src/data/historic/{slug}.ts (structures, tours, exhibits, etc.)
 *
 * Uses Vite's import.meta.glob() for auto-discovery of data files.
 * To add a new historic site: just add the .ts data file and .md content entry.
 */

import { getCollection, type CollectionEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import Layout from '../../layouts/Layout.astro';
import HistoricTemplate from '../../components/templates/HistoricTemplate.astro';
import SchemaHistoricTemplate from '../../components/seo/SchemaHistoricTemplate.astro';
import type { HistoricTemplateProps } from '../../types/templates/historic';
import { toDataSlug } from '../../utils/historic-slug';

// Type for data map (slug -> module exports)
type HistoricDataMap = Record<string, Record<string, unknown>>;

// Explicit props interface for better type inference
interface Props {
  entry: CollectionEntry<'adventures'>;
  dataMap: HistoricDataMap;
}

// ============================================================================
// STATIC PATH GENERATION WITH AUTO-DISCOVERY
// ============================================================================
// Uses Vite's import.meta.glob() for build-time auto-discovery.
// All logic is inlined in getStaticPaths per Astro's bundling requirements.

export const getStaticPaths: GetStaticPaths = async () => {
  // AUTO-DISCOVER: Vite glob imports all .ts files in /src/data/historic/
  // This MUST be called inside getStaticPaths for Astro compatibility
  const dataModules = import.meta.glob<Record<string, unknown>>(
    '../../data/historic/*.ts',
    { eager: true }
  );

  // Transform glob result into slug-keyed map
  // Path: "../../data/historic/carnifex-ferry.ts" â†’ slug: "carnifex-ferry"
  const dataMap: Record<string, Record<string, unknown>> = {};
  for (const [path, module] of Object.entries(dataModules)) {
    const filename = path.split('/').pop() ?? '';
    const slug = filename.replace('.ts', '');
    dataMap[slug] = module;
  }

  const availableDataSlugs = Object.keys(dataMap);
  const adventures = await getCollection('adventures');

  // Filter to entries that have matching data files (auto-discovered)
  const historicEntries = adventures.filter((entry) => {
    const contentSlug = entry.data.slug || entry.id.replace(/\.md$/, '');
    return availableDataSlugs.includes(toDataSlug(contentSlug));
  });

  return historicEntries.map((entry) => {
    const slug = entry.data.slug || entry.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { entry, dataMap },
    };
  });
};

// ============================================================================
// PAGE PROPS
// ============================================================================

const { entry, dataMap } = Astro.props as Props;
const contentSlug = entry.data.slug || entry.id.replace(/\.md$/, '');
const dataSlug = toDataSlug(contentSlug);

const historicData = dataMap[dataSlug];
if (!historicData) {
  const availableDataSlugs = Object.keys(dataMap);
  throw new Error(`No historic data file found for slug: ${dataSlug}. Available: ${availableDataSlugs.join(', ')}`);
}

// Type assertion for structured data
const typedData = historicData as {
  historicalContext: HistoricTemplateProps['historicalContext'];
  structures: HistoricTemplateProps['structures'];
  siteMapUrl?: string;
  tours: HistoricTemplateProps['tours'];
  exhibits?: HistoricTemplateProps['exhibits'];
  education: HistoricTemplateProps['education'];
  visitorInfo: HistoricTemplateProps['visitorInfo'];
  nearbyHistory?: HistoricTemplateProps['nearbyHistory'];
  coordinates?: { lat: number; lng: number };
  managingAgency?: string;
};

// Merge frontmatter + data file for complete props
const templateProps: HistoricTemplateProps = {
  // From content collection frontmatter
  name: entry.data.title,
  location: entry.data.location,
  era: entry.data.tagline || 'Historic Site',
  significance: entry.data.description,
  nationalRegister: true,
  quickHighlights: entry.data.quickStats || [],
  heroImage: entry.data.heroImage || entry.data.image || '/images/placeholder-historic.jpg',
  heroImageAlt: entry.data.imageAlt || `${entry.data.title} historic site`,

  // From data file (structured historic data)
  historicalContext: typedData.historicalContext,
  structures: typedData.structures,
  siteMapUrl: typedData.siteMapUrl,
  tours: typedData.tours,
  exhibits: typedData.exhibits,
  education: typedData.education,
  visitorInfo: typedData.visitorInfo,
  nearbyHistory: typedData.nearbyHistory,
};

// Schema props for SEO
// Use frontmatter dates if available, fallback to current date
// (Future: Add publishedDate/updatedDate to adventures schema for accurate article dates)
const frontmatterData = entry.data as Record<string, unknown>;
const publishedDate = frontmatterData.publishedDate
  ? new Date(frontmatterData.publishedDate as string).toISOString()
  : frontmatterData.date
    ? new Date(frontmatterData.date as string).toISOString()
    : new Date().toISOString();
const updatedDate = frontmatterData.updatedDate
  ? new Date(frontmatterData.updatedDate as string).toISOString()
  : publishedDate;

const schemaProps = {
  name: entry.data.title,
  slug: contentSlug,
  description: entry.data.description,
  location: entry.data.location,
  era: entry.data.tagline || 'Historic Site',
  coordinates: entry.data.coordinates || typedData.coordinates,
  nationalRegister: true,
  imageUrl: entry.data.heroImage
    ? `${Astro.site?.href || 'https://wvwildoutdoors.pages.dev'}${entry.data.heroImage}`
    : undefined,
  managingAgency: typedData.managingAgency,
  structureCount: typedData.structures?.length,
  tourCount: typedData.tours?.length,
  publishedDate,
  updatedDate,
};

// Meta tags
const pageTitle = `${entry.data.title} | Historic Sites | WV Wild Outdoors`;
const metaDescription = `${entry.data.description.slice(0, 150)}...`;
---

<Layout title={pageTitle} description={metaDescription}>
  <!-- JSON-LD Structured Data -->
  <SchemaHistoricTemplate {...schemaProps} slot="head" />

  <!-- Geo Meta Tags -->
  {entry.data.coordinates && (
    <Fragment slot="head">
      <meta name="geo.position" content={`${entry.data.coordinates.lat};${entry.data.coordinates.lng}`} />
      <meta name="geo.placename" content={entry.data.title} />
      <meta name="geo.region" content="US-WV" />
    </Fragment>
  )}

  <!-- Historic Site Classification Meta -->
  <Fragment slot="head">
    <meta name="wvwo:template" content="historic" />
    <meta name="wvwo:era" content={templateProps.era} />
    {templateProps.nationalRegister && (
      <meta name="wvwo:national-register" content="true" />
    )}
  </Fragment>

  <!-- Render HistoricTemplate -->
  <HistoricTemplate {...templateProps} />
</Layout>
