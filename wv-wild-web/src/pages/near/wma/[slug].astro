---
/**
 * WMA Page - Dynamic Route
 * SPEC-21: Dynamic route for WMA hunting content
 *
 * Renders WMATemplate with data from /src/data/wma/{slug}.ts
 * Uses Vite's import.meta.glob() for auto-discovery of data files.
 *
 * To add a new WMA: just add the .ts data file in /src/data/wma/
 */

import type { GetStaticPaths } from 'astro';
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import EmailCapture from '../../../components/EmailCapture.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import SchemaBreadcrumb from '../../../components/seo/SchemaBreadcrumb.astro';
import WMATemplate from '../../../components/templates/WMATemplate.astro';
import type { WMATemplateProps } from '../../../types/wma';

// Type for data modules
type WMADataModule = {
  [key: string]: WMATemplateProps;
};

interface Props {
  wmaData: WMATemplateProps;
  slug: string;
  hasRelatedLake: boolean;
}

// ============================================================================
// STATIC PATH GENERATION WITH AUTO-DISCOVERY
// ============================================================================

export const getStaticPaths: GetStaticPaths = async () => {
  // AUTO-DISCOVER: Vite glob imports all .ts files in /src/data/wma/
  const dataModules = import.meta.glob<WMADataModule>(
    '../../../data/wma/*.ts',
    { eager: true }
  );

  // Also discover lake data to check for related lakes
  const lakeModules = import.meta.glob(
    '../../../data/lakes/*.ts',
    { eager: true }
  );
  const lakeSlugSet = new Set(
    Object.keys(lakeModules).map(path => {
      const filename = path.split('/').pop() ?? '';
      return filename.replace('.ts', '');
    }).filter(slug => !slug.startsWith('_'))
  );

  const paths = [];

  for (const [path, module] of Object.entries(dataModules)) {
    const filename = path.split('/').pop() ?? '';
    // Skip example/template files
    if (filename.startsWith('_')) continue;

    const slug = filename.replace('.ts', '');

    // Find the exported data (look for WMATemplateProps-shaped export)
    const exportedData = Object.values(module).find(
      (value): value is WMATemplateProps =>
        typeof value === 'object' && value !== null && 'name' in value && 'species' in value
    );

    if (exportedData) {
      paths.push({
        params: { slug },
        props: {
          wmaData: exportedData,
          slug,
          hasRelatedLake: lakeSlugSet.has(slug),
        },
      });
    }
  }

  return paths;
};

// ============================================================================
// PAGE PROPS
// ============================================================================

const { wmaData, slug, hasRelatedLake } = Astro.props;

// Place schema for geographic SEO
const placeSchema = {
  "@context": "https://schema.org",
  "@type": "Place",
  "name": wmaData.name,
  "description": wmaData.description,
  "geo": wmaData.coordinates ? {
    "@type": "GeoCoordinates",
    "latitude": wmaData.coordinates.lat,
    "longitude": wmaData.coordinates.lng,
  } : undefined,
  "address": {
    "@type": "PostalAddress",
    "addressRegion": "WV",
    "addressCountry": "US",
  },
  "amenityFeature": [
    { "@type": "LocationFeatureSpecification", "name": "Hunting", "value": true },
    { "@type": "LocationFeatureSpecification", "name": "Wildlife Management", "value": true },
    { "@type": "LocationFeatureSpecification", "name": "Public Access", "value": true },
  ],
};

// Breadcrumb data
const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Near Us', url: '/near/' },
  { name: wmaData.name, url: `/near/wma/${slug}/` },
];

// Meta
const pageTitle = `${wmaData.name} Hunting Guide | WV Wild Outdoors`;
const metaDescription = wmaData.description.slice(0, 155) + (wmaData.description.length > 155 ? '...' : '');
---

<Layout
  title={pageTitle}
  description={metaDescription}
  additionalSchemas={[placeSchema]}
>
  <Header />
  <Breadcrumb items={breadcrumbItems} />
  <SchemaBreadcrumb items={breadcrumbItems} />

  <WMATemplate {...wmaData} />

  {/* Cross-link to Lake fishing page if exists */}
  {hasRelatedLake && (
    <section class="py-8 bg-white border-t border-brand-brown/15">
      <div class="container mx-auto px-4">
        <div class="max-w-3xl mx-auto text-center">
          <p class="text-brand-brown/60 mb-3 font-body">Looking for fishing information?</p>
          <a
            href={`/near/lake/${slug}/`}
            class="inline-flex items-center gap-2 text-sign-green font-bold hover:underline font-body"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
            </svg>
            {wmaData.name.replace(' WMA', '')} Fishing Guide
          </a>
        </div>
      </div>
    </section>
  )}

  {/* Newsletter signup */}
  <section class="py-12 md:py-16 bg-brand-cream">
    <div class="container mx-auto px-4">
      <div class="max-w-xl mx-auto">
        <EmailCapture
          variant="card"
          heading="Get Local Hunting Updates"
          subheading="Season dates, regulations changes, and what's happening in the woods - delivered to your inbox."
        />
      </div>
    </div>
  </section>

  <Footer />
</Layout>
