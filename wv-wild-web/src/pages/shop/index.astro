---
/**
 * /shop - Main shop page with all products and filtering
 */
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProductCard from '../../components/shop/ProductCard.astro';
import { CategoryShowcase } from '../../components/shop/CategoryShowcase';
import { SITE_CONTACT } from '../../config/siteContact';
import storeData from '../../data/store.json';

const { categories, products } = storeData;

// Get unique brands for filter
const brands = [...new Set(products.map(p => p.brand))].sort();
---

<Layout
  title="Shop | WV Wild Outdoors"
  description="Browse our selection of firearms, ammunition, and fishing gear. Shop online for shippable items or call us for firearms and ammunition."
>
  <Header />

  <main class="bg-brand-cream min-h-screen">
    <!-- Hero -->
    <section class="bg-brand-brown text-white py-10 md:py-14">
      <div class="container mx-auto px-4">
        <h1 class="font-display font-black text-4xl md:text-5xl mb-3">Shop</h1>
        <p class="text-brand-cream/80 text-lg max-w-2xl">
          Firearms, ammunition, and fishing gear from the brands you trust.
          Shippable items available for online purchase.
        </p>
      </div>
    </section>

    <!-- Shop Content -->
    <section class="py-8 md:py-12">
      <div class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-8">

          <!-- Filters Sidebar -->
          <aside class="lg:w-64 flex-shrink-0">
            <div class="bg-white rounded-sm shadow-sm border border-stone-100 p-5 sticky top-4">
              <h2 class="font-display font-bold text-lg text-brand-brown mb-4">Filters</h2>

              <!-- Search -->
              <div class="mb-6">
                <label for="search-input" class="block text-sm font-medium text-stone-700 mb-2">
                  Search
                </label>
                <input
                  type="text"
                  id="search-input"
                  placeholder="Search products..."
                  class="w-full px-3 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green text-sm"
                  data-search-input
                />
              </div>

              <!-- Category Filter -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-stone-700 mb-2">Category</h3>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input
                      type="radio"
                      name="category"
                      value=""
                      checked
                      class="text-sign-green focus:ring-sign-green"
                      data-filter-category
                    />
                    <span class="text-sm text-stone-600">All Categories</span>
                  </label>
                  {categories.map(cat => (
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="category"
                        value={cat.id}
                        class="text-sign-green focus:ring-sign-green"
                        data-filter-category
                      />
                      <span class="text-sm text-stone-600">{cat.name}</span>
                    </label>
                  ))}
                </div>
              </div>

              <!-- Brand Filter -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-stone-700 mb-2">Brand</h3>
                <select
                  id="brand-filter"
                  class="w-full px-3 py-2 border border-stone-300 rounded focus:outline-none focus:ring-2 focus:ring-sign-green/50 focus:border-sign-green text-sm"
                  data-filter-brand
                >
                  <option value="">All Brands</option>
                  {brands.map(brand => (
                    <option value={brand}>{brand}</option>
                  ))}
                </select>
              </div>

              <!-- In Stock Only -->
              <div class="mb-6">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    class="rounded text-sign-green focus:ring-sign-green"
                    data-filter-instock
                  />
                  <span class="text-sm text-stone-600">In Stock Only</span>
                </label>
              </div>

              <!-- Clear Filters -->
              <button
                type="button"
                class="w-full text-sm text-brand-orange hover:underline"
                data-clear-filters
              >
                Clear All Filters
              </button>
            </div>
          </aside>

          <!-- Products Grid -->
          <div class="flex-1">
            <!-- Results Count -->
            <div class="flex items-center justify-between mb-6">
              <p class="text-stone-600">
                <span data-results-count>{products.length}</span> products
              </p>
              <p class="text-sm text-stone-500 hidden" data-no-results>
                No products match your filters.
              </p>
            </div>

            <!-- Product Grid -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"
              id="products-grid"
            >
              {products.map(product => {
                const category = categories.find(c => c.id === product.categoryId);
                return (
                  <div
                    data-product
                    data-category={product.categoryId}
                    data-brand={product.brand}
                    data-instock={product.inStock}
                    data-name={product.name.toLowerCase()}
                    data-tags={(product.tags || []).join(' ')}
                  >
                    <ProductCard product={product} categorySlug={category?.slug || product.categoryId} />
                  </div>
                );
              })}
            </div>

            <!-- Empty State -->
            <div class="hidden text-center py-12" data-empty-state>
              <svg class="w-16 h-16 text-stone-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <h3 class="font-display font-bold text-lg text-brand-brown mb-2">No Products Found</h3>
              <p class="text-stone-600 mb-4">Try adjusting your filters or search term.</p>
              <button
                type="button"
                class="text-brand-orange hover:underline"
                data-clear-filters
              >
                Clear All Filters
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Browse by Category -->
    <section class="py-12 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="font-display font-bold text-2xl text-brand-brown text-center mb-8">
          Browse by Category
        </h2>
        <CategoryShowcase categories={categories} client:visible />
      </div>
    </section>

    <!-- FFL Notice -->
    <section class="bg-brand-mud text-brand-cream py-6">
      <div class="container mx-auto px-4 text-center">
        <p class="text-sm text-brand-cream/70">
          <strong class="text-white">Firearms & Ammunition:</strong> Cannot be shipped.
          Call <a href={SITE_CONTACT.phoneHref} class="text-sign-green hover:underline">{SITE_CONTACT.phoneDisplay}</a> to order.
          All sales require federal background check (NICS). Must be 18+ for long guns, 21+ for handguns.
        </p>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  function initShopFilters() {
    const grid = document.getElementById('products-grid');
    const searchInput = document.querySelector('[data-search-input]') as HTMLInputElement;
    const categoryInputs = document.querySelectorAll('[data-filter-category]') as NodeListOf<HTMLInputElement>;
    const brandSelect = document.querySelector('[data-filter-brand]') as HTMLSelectElement;
    const instockCheckbox = document.querySelector('[data-filter-instock]') as HTMLInputElement;
    const clearButtons = document.querySelectorAll('[data-clear-filters]');
    const resultsCount = document.querySelector('[data-results-count]');
    const emptyState = document.querySelector('[data-empty-state]');
    const noResults = document.querySelector('[data-no-results]');

    if (!grid) return;

    // Idempotency guard
    if (grid.dataset.filtersInit === 'true') return;
    grid.dataset.filtersInit = 'true';

    const products = grid.querySelectorAll('[data-product]') as NodeListOf<HTMLElement>;

    function applyFilters() {
      const searchTerm = searchInput?.value.toLowerCase().trim() || '';
      const selectedCategory = (document.querySelector('[data-filter-category]:checked') as HTMLInputElement)?.value || '';
      const selectedBrand = brandSelect?.value || '';
      const instockOnly = instockCheckbox?.checked || false;

      let visibleCount = 0;

      products.forEach(product => {
        const category = product.dataset.category || '';
        const brand = product.dataset.brand || '';
        const instock = product.dataset.instock === 'true';
        const name = product.dataset.name || '';
        const tags = product.dataset.tags || '';

        let show = true;

        // Category filter
        if (selectedCategory && category !== selectedCategory) {
          show = false;
        }

        // Brand filter
        if (selectedBrand && brand !== selectedBrand) {
          show = false;
        }

        // In stock filter
        if (instockOnly && !instock) {
          show = false;
        }

        // Search filter
        if (searchTerm && !name.includes(searchTerm) && !tags.includes(searchTerm) && !brand.toLowerCase().includes(searchTerm)) {
          show = false;
        }

        product.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      // Update count
      if (resultsCount) {
        resultsCount.textContent = visibleCount.toString();
      }

      // Show/hide empty state
      if (emptyState) {
        emptyState.classList.toggle('hidden', visibleCount > 0);
      }
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }

      // Update URL params
      const params = new URLSearchParams();
      if (selectedCategory) params.set('category', selectedCategory);
      if (selectedBrand) params.set('brand', selectedBrand);
      if (instockOnly) params.set('instock', 'true');
      if (searchTerm) params.set('q', searchTerm);

      const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function clearFilters() {
      if (searchInput) searchInput.value = '';
      categoryInputs.forEach(input => {
        input.checked = input.value === '';
      });
      if (brandSelect) brandSelect.value = '';
      if (instockCheckbox) instockCheckbox.checked = false;
      applyFilters();
    }

    // Load filters from URL on init
    function loadFiltersFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const category = params.get('category');
      const brand = params.get('brand');
      const instock = params.get('instock');
      const search = params.get('q');

      if (category) {
        const input = document.querySelector(`[data-filter-category][value="${category}"]`) as HTMLInputElement;
        if (input) input.checked = true;
      }
      if (brand && brandSelect) brandSelect.value = brand;
      if (instock === 'true' && instockCheckbox) instockCheckbox.checked = true;
      if (search && searchInput) searchInput.value = search.replace(/[<>]/g, '');

      applyFilters();
    }

    // Event listeners
    searchInput?.addEventListener('input', applyFilters);
    categoryInputs.forEach(input => input.addEventListener('change', applyFilters));
    brandSelect?.addEventListener('change', applyFilters);
    instockCheckbox?.addEventListener('change', applyFilters);
    clearButtons.forEach(btn => btn.addEventListener('click', clearFilters));

    // Init from URL
    loadFiltersFromUrl();

    // Cleanup for ViewTransitions
    document.addEventListener('astro:before-swap', () => {
      grid.dataset.filtersInit = 'false';
    }, { once: true });
  }

  initShopFilters();
  document.addEventListener('astro:page-load', initShopFilters);
</script>
