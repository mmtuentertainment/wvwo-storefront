# WV Wild Outdoors - Local Development Stack
# Complete Docker Compose orchestration for all services
# Usage: docker compose up -d

version: "3.8"

# Custom network for service communication
networks:
  wvwo-dev:
    driver: bridge
    name: wvwo-dev

# Named volumes for data persistence
volumes:
  postgres-data:
    name: wvwo-postgres-data-dev
  redis-data:
    name: wvwo-redis-data-dev
  directus-uploads:
    name: wvwo-directus-uploads-dev
  ghost-content:
    name: wvwo-ghost-content-dev

services:
  # ===========================================
  # PostgreSQL 15 Database (Foundation)
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: wvwo-postgres-dev
    restart: unless-stopped
    networks:
      - wvwo-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init-scripts:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    stop_grace_period: 30s

  # ===========================================
  # Redis 7 Cache
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: wvwo-redis-dev
    restart: unless-stopped
    networks:
      - wvwo-dev
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - redis-data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    stop_grace_period: 30s

  # ===========================================
  # Directus 10 CMS
  # ===========================================
  directus:
    image: directus/directus:10
    container_name: wvwo-directus-dev
    restart: unless-stopped
    networks:
      - wvwo-dev
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      KEY: ${DIRECTUS_KEY}
      SECRET: ${DIRECTUS_SECRET}
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD}
      DB_CLIENT: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: directus
      DB_USER: directus_user
      DB_PASSWORD: directuspass123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CACHE_ENABLED: "true"
      CACHE_STORE: redis
      PUBLIC_URL: http://localhost:8055
      STORAGE_LOCATIONS: local
      CORS_ENABLED: "true"
      CORS_ORIGIN: "http://localhost:3000"
    ports:
      - "8055:8055"
    volumes:
      - directus-uploads:/directus/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8055/server/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    stop_grace_period: 30s

  # ===========================================
  # Ghost 5 Blog
  # ===========================================
  ghost:
    image: ghost:5.96.0
    container_name: wvwo-ghost-dev
    restart: unless-stopped
    networks:
      - wvwo-dev
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: development
      url: http://localhost:2368
      database__client: postgres
      database__connection__host: postgres
      database__connection__port: 5432
      database__connection__user: ghost_user
      database__connection__password: ghostpass123
      database__connection__database: ghost
    ports:
      - "2368:2368"
    volumes:
      - ghost-content:/var/lib/ghost/content
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2368/ghost/api/v3/admin/site/"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    stop_grace_period: 30s

  # ===========================================
  # Astro Frontend (Dev Server)
  # NOTE: Commented out until Astro application is created
  # Uncomment when astro/ directory exists with package.json
  # ===========================================
  # astro:
  #   build:
  #     context: ./astro
  #     dockerfile: ../docker/astro/Dockerfile
  #   container_name: wvwo-astro-dev
  #   restart: unless-stopped
  #   networks:
  #     - wvwo-dev
  #   depends_on:
  #     directus:
  #       condition: service_healthy
  #     ghost:
  #       condition: service_healthy
  #   environment:
  #     PUBLIC_DIRECTUS_URL: http://directus:8055
  #     PUBLIC_GHOST_URL: http://ghost:2368
  #     NODE_ENV: development
  #   ports:
  #     - "3000:3000"
  #   volumes:
  #     - ./astro:/app
  #     - /app/node_modules
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:3000/"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 20s
  #   stop_grace_period: 30s

  # ===========================================
  # Listmonk Email/Newsletter
  # ===========================================
  listmonk:
    image: listmonk/listmonk:latest
    container_name: wvwo-listmonk-dev
    restart: unless-stopped
    networks:
      - wvwo-dev
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      TZ: America/New_York
      LISTMONK_app__address: "0.0.0.0:9000"
      LISTMONK_db__host: postgres
      LISTMONK_db__port: 5432
      LISTMONK_db__user: listmonk_user
      LISTMONK_db__password: listmonkpass123
      LISTMONK_db__database: listmonk
      LISTMONK_db__ssl_mode: disable
    ports:
      - "9000:9000"
    command: ["sh", "-c", "./listmonk --install --yes && ./listmonk"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    stop_grace_period: 30s

  # ===========================================
  # Mixpost Social Media Management
  # ===========================================
  mixpost:
    image: inovector/mixpost:latest
    container_name: wvwo-mixpost-dev
    restart: unless-stopped
    networks:
      - wvwo-dev
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      APP_URL: http://localhost:8080
      APP_KEY: ${MIXPOST_APP_KEY}
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: mixpost
      DB_USERNAME: mixpost_user
      DB_PASSWORD: mixpostpass123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET}
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    stop_grace_period: 30s

# ===========================================
# Development Commands Quick Reference
# ===========================================
# Start:   docker compose up -d
# Stop:    docker compose down
# Clean:   docker compose down -v
# Logs:    docker compose logs -f [service]
# Status:  docker compose ps
# Restart: docker compose restart [service]
# Rebuild: docker compose up -d --build [service]
